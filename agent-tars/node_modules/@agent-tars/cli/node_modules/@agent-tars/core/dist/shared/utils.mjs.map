{"version":3,"file":"shared/utils.mjs","sources":["webpack://@agent-tars/core/./src/shared/utils.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n/*\n * Copyright (c) 2025 Bytedance, Inc. and its affiliates.\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport imagemin from 'imagemin';\nimport imageminPngquant from 'imagemin-pngquant';\n// @ts-expect-error\nimport imageminMozjpeg from 'imagemin-mozjpeg';\n// @ts-expect-error\nimport imageminWebp from 'imagemin-webp';\n\nexport interface ImageCompressionOptions {\n  quality: number; // Compression quality (1-100)\n  format?: 'jpeg' | 'png' | 'webp';\n  width?: number; // Optional target width\n  height?: number; // Optional target height\n  tempDir?: string; // Temporary directory\n}\n\nexport interface CompressionResult {\n  originalSize: number;\n  compressedSize: number;\n  compressionRatio: number;\n  path: string;\n  buffer: Buffer;\n}\n\n/**\n * High-performance image compression utility class\n */\nexport class ImageCompressor {\n  public readonly options: ImageCompressionOptions;\n\n  constructor(options?: ImageCompressionOptions) {\n    // Set default options\n    this.options = {\n      quality: options?.quality ?? 80,\n      format: options?.format ?? 'webp',\n      width: options?.width,\n      height: options?.height,\n    };\n  }\n\n  /**\n   * Compress image and return Buffer without writing to file\n   * @param imageBuffer Image Buffer\n   */\n  async compressToBuffer(imageBuffer: Buffer): Promise<Buffer> {\n    // Choose appropriate compression plugin\n    const plugins = this.getPluginsForFormat();\n\n    // Compress image\n    return await imagemin.buffer(imageBuffer, {\n      plugins,\n    });\n  }\n\n  /**\n   * Select plugins based on target format\n   */\n  private getPluginsForFormat() {\n    const quality = this.options.quality / 100; // Convert to 0-1 range (required by some plugins)\n\n    switch (this.options.format) {\n      case 'jpeg':\n        return [imageminMozjpeg({ quality: this.options.quality })];\n      case 'png':\n        return [\n          imageminPngquant({\n            quality: [quality, Math.min(quality + 0.2, 1)],\n          }),\n        ];\n      case 'webp':\n        return [imageminWebp({ quality: this.options.quality })];\n      default:\n        return [imageminWebp({ quality: this.options.quality })];\n    }\n  }\n\n  /**\n   * Get formatted description of current compression options\n   */\n  getOptionsDescription(): string {\n    return `Quality: ${this.options.quality}, Format: ${this.options.format}${\n      this.options.width ? `, Width: ${this.options.width}px` : ''\n    }${this.options.height ? `, Height: ${this.options.height}px` : ''}`;\n  }\n}\n\n/**\n * Format byte size to human readable format\n * @param bytes Number of bytes\n */\nexport function formatBytes(bytes: number): string {\n  if (bytes === 0) return '0 Bytes';\n  const k = 1024;\n  const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;\n}\n"],"names":["ImageCompressor","imageBuffer","plugins","imagemin","quality","imageminMozjpeg","imageminPngquant","Math","imageminWebp","options","formatBytes","bytes","k","sizes","i","parseFloat"],"mappings":";;;;;;;;AAIC;;;;;;;;;;AA4BM,MAAMA;IAiBX,MAAM,iBAAiBC,WAAmB,EAAmB;QAE3D,MAAMC,UAAU,IAAI,CAAC,mBAAmB;QAGxC,OAAO,MAAMC,0BAAAA,MAAe,CAACF,aAAa;YACxCC;QACF;IACF;IAKQ,sBAAsB;QAC5B,MAAME,UAAU,IAAI,CAAC,OAAO,CAAC,OAAO,GAAG;QAEvC,OAAQ,IAAI,CAAC,OAAO,CAAC,MAAM;YACzB,KAAK;gBACH,OAAO;oBAACC,kCAAgB;wBAAE,SAAS,IAAI,CAAC,OAAO,CAAC,OAAO;oBAAC;iBAAG;YAC7D,KAAK;gBACH,OAAO;oBACLC,mCAAiB;wBACf,SAAS;4BAACF;4BAASG,KAAK,GAAG,CAACH,UAAU,KAAK;yBAAG;oBAChD;iBACD;YACH,KAAK;gBACH,OAAO;oBAACI,+BAAa;wBAAE,SAAS,IAAI,CAAC,OAAO,CAAC,OAAO;oBAAC;iBAAG;YAC1D;gBACE,OAAO;oBAACA,+BAAa;wBAAE,SAAS,IAAI,CAAC,OAAO,CAAC,OAAO;oBAAC;iBAAG;QAC5D;IACF;IAKA,wBAAgC;QAC9B,OAAO,CAAC,SAAS,EAAE,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,UAAU,EAAE,IAAI,CAAC,OAAO,CAAC,MAAM,GACrE,IAAI,CAAC,OAAO,CAAC,KAAK,GAAG,CAAC,SAAS,EAAE,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,CAAC,GAAG,KACzD,IAAI,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC,UAAU,EAAE,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC,GAAG,IAAI;IACtE;IArDA,YAAYC,OAAiC,CAAE;QAF/C,uBAAgB,WAAhB;QAIE,IAAI,CAAC,OAAO,GAAG;YACb,SAASA,AAAAA,CAAAA,QAAAA,UAAAA,KAAAA,IAAAA,QAAS,OAAO,AAAD,KAAK;YAC7B,QAAQA,AAAAA,CAAAA,QAAAA,UAAAA,KAAAA,IAAAA,QAAS,MAAM,AAAD,KAAK;YAC3B,OAAOA,QAAAA,UAAAA,KAAAA,IAAAA,QAAS,KAAK;YACrB,QAAQA,QAAAA,UAAAA,KAAAA,IAAAA,QAAS,MAAM;QACzB;IACF;AA8CF;AAMO,SAASC,YAAYC,KAAa;IACvC,IAAIA,AAAU,MAAVA,OAAa,OAAO;IACxB,MAAMC,IAAI;IACV,MAAMC,QAAQ;QAAC;QAAS;QAAM;QAAM;KAAK;IACzC,MAAMC,IAAIP,KAAK,KAAK,CAACA,KAAK,GAAG,CAACI,SAASJ,KAAK,GAAG,CAACK;IAChD,OAAO,GAAGG,WAAYJ,AAAAA,CAAAA,QAAQJ,KAAK,GAAG,CAACK,GAAGE,EAAC,EAAG,OAAO,CAAC,IAAI,CAAC,EAAED,KAAK,CAACC,EAAE,EAAE;AACzE"}