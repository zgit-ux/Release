{"version":3,"file":"gui-agent.mjs","sources":["webpack://@agent-tars/core/./src/gui-agent.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n/*\n * Copyright (c) 2025 Bytedance, Inc. and its affiliates.\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { LocalBrowser } from '@agent-infra/browser';\nimport { BrowserOperator } from '@ui-tars/operator-browser';\nimport { ConsoleLogger, EventStream, Tool, ToolDefinition, z } from '@multimodal/mcp-agent';\nimport { EventType } from '@multimodal/mcp-agent';\nimport { Page } from 'puppeteer-core';\n\n/**\n * Coordinate type definition\n */\nexport type Coords = [number, number] | [];\n\n/**\n * Action input parameters for browser actions\n */\nexport interface ActionInputs {\n  content?: string;\n  start_box?: string;\n  end_box?: string;\n  key?: string;\n  hotkey?: string;\n  direction?: string;\n  start_coords?: Coords;\n  end_coords?: Coords;\n}\n\nfunction sleep(time: number) {\n  return new Promise(function (resolve) {\n    setTimeout(resolve, time);\n  });\n}\n\n/**\n * Parsed prediction from GUI agent\n */\nexport interface PredictionParsed {\n  /** Action inputs parsed from action_type(action_inputs) */\n  action_inputs: ActionInputs;\n  /** Action type parsed from action_type(action_inputs) */\n  action_type: string;\n  /** Thinking content */\n  thought?: string;\n}\n\n/**\n * Browser initialization options\n */\nexport interface GUIAgentOptions {\n  /** browser instance to use */\n  browser: LocalBrowser;\n  /** The logger instance to use */\n  logger: ConsoleLogger;\n  /** Whether to run browser in headless mode */\n  headless?: boolean;\n  /** Scaling factors for coordinates */\n  factors?: [number, number];\n  /** Event stream instance for injecting environment info */\n  eventStream?: EventStream;\n}\n\n/**\n * GUI Agent for visual browser automation\n */\nexport class GUIAgent {\n  private browser: LocalBrowser;\n  private browserOperator: BrowserOperator;\n  private screenWidth?: number;\n  private screenHeight?: number;\n  private guiAgentTool: ToolDefinition;\n  private logger: ConsoleLogger;\n  private factors: [number, number];\n  private eventStream?: EventStream;\n\n  /**\n   * Creates a new GUI Agent\n   * @param options - Configuration options\n   */\n  constructor(private options: GUIAgentOptions) {\n    this.logger = options.logger;\n    this.factors = options.factors || [1000, 1000];\n    this.eventStream = options.eventStream;\n\n    // Use provided browser instance\n    this.browser = this.options.browser;\n\n    // Initialize browser operator\n    this.browserOperator = new BrowserOperator({\n      browser: this.browser,\n      browserType: 'chrome',\n      logger: this.logger,\n      highlightClickableElements: false,\n      showActionInfo: false,\n      showWaterFlow: false,\n    });\n\n    // Create the tool definition\n    this.guiAgentTool = new Tool({\n      id: 'browser_vision_control',\n      description: `A browser operation tool based on visual understanding, perform the next action to complete the task.\n\n## Action Space\n\nclick(point='<point>x1 y1</point>')            - Click at the specified coordinates\nleft_double(point='<point>x1 y1</point>')      - Double-click at the specified coordinates\nright_single(point='<point>x1 y1</point>')     - Right-click at the specified coordinates\ndrag(start_point='<point>x1 y1</point>', end_point='<point>x2 y2</point>') - Drag from start to end point\nhotkey(key='ctrl c')                           - Press keyboard shortcut (use space to separate keys, lowercase)\ntype(content='xxx')                            - Type text content (use \\\\', \\\\\", and \\\\n for special characters)\nscroll(point='<point>x1 y1</point>', direction='down or up or right or left') - Scroll in specified direction\nwait()                                         - Wait 5 seconds and take a screenshot to check for changes\n\n## Note\n- Folow user lanuage in in \\`thought\\` part.\n- Describe your thought in \\`step\\` part.\n- Describe your action in \\`Step\\` part.\n- Extract the data your see in \\`pageData\\` part.\n- This tool is for operational tasks, not for collect information.\n`,\n      parameters: z.object({\n        thought: z\n          .string()\n          .describe(\n            'Your observation and small plan in one sentence, DO NOT include \" characters to avoid failure to render in JSON',\n          ),\n        step: z\n          .string()\n          .describe('Finally summarize the next action (with its target element) in one sentence'),\n        action: z.string().describe('Some action in action space like click or press'),\n        // pageData: z\n        //   .array(z.object({}))\n        //   .describe(\"The information you see and extract from the page based on the user's query\")\n        //   .optional(),\n      }),\n      function: async ({ thought, step, action, pageData }) => {\n        try {\n          const parsed = this.parseAction(action);\n          parsed.thought = thought;\n\n          this.logger.debug({\n            thought,\n            step,\n            action,\n            parsedAction: JSON.stringify(parsed, null, 2),\n            screenDimensions: {\n              width: this.screenWidth,\n              height: this.screenHeight,\n            },\n          });\n\n          const result = await this.browserOperator.execute({\n            parsedPrediction: parsed,\n            screenWidth: this.screenWidth || 1920,\n            screenHeight: this.screenHeight || 1080,\n          });\n\n          await sleep(500);\n\n          // Automatically get page content after browser interaction\n          // await this.capturePageContentAsEnvironmentInfo();\n\n          return { action, status: 'success', result, pageData };\n        } catch (error) {\n          this.logger.error(\n            `Browser action failed: ${error instanceof Error ? error.message : String(error)}`,\n          );\n          return {\n            action,\n            status: 'fail',\n            error: error instanceof Error ? error.message : String(error),\n          };\n        }\n      },\n    });\n  }\n\n  /**\n   * Capture page content and add it to event stream as environment info\n   * This is called automatically after each browser_vision_control action\n   */\n  private async capturePageContentAsEnvironmentInfo(): Promise<void> {\n    // Only proceed if eventStream is provided\n    if (!this.eventStream) return;\n\n    try {\n      const page = await this.getPage();\n\n      // Get page content as markdown\n      const markdown = await page.evaluate(() => {\n        // Simple function to extract page content as markdown\n        const extractMarkdown = () => {\n          // Get page title\n          const title = document.title || 'Untitled Page';\n\n          // @ts-expect-error\n          // Get visible text content\n          const getVisibleText = (node) => {\n            if (node.nodeType === Node.TEXT_NODE) {\n              return node.textContent || '';\n            }\n\n            const style = window.getComputedStyle(node);\n            if (\n              style.display === 'none' ||\n              style.visibility === 'hidden' ||\n              style.opacity === '0'\n            ) {\n              return '';\n            }\n\n            let text = '';\n            for (const child of Array.from(node.childNodes)) {\n              // @ts-expect-error\n              if (child.nodeType === Node.ELEMENT_NODE) {\n                text += getVisibleText(child);\n                // @ts-expect-error\n              } else if (child.nodeType === Node.TEXT_NODE) {\n                // @ts-expect-error\n                text += child.textContent || '';\n              }\n            }\n\n            return text.trim();\n          };\n\n          // Get main content, prefer article or main elements\n          const mainContent =\n            document.querySelector('article, main, #content, .content') || document.body;\n          const content = getVisibleText(mainContent);\n\n          // Format as markdown\n          return `# ${title}\\n\\n${content}`;\n        };\n\n        return extractMarkdown();\n      });\n\n      // If content is available, add it to event stream\n      if (markdown && markdown.trim()) {\n        // Create an environment input event with the markdown content\n        const event = this.eventStream.createEvent(EventType.ENVIRONMENT_INPUT, {\n          content: markdown,\n          description: 'Page Content After Browser Action',\n        });\n\n        // Send the event\n        this.eventStream.sendEvent(event);\n        this.logger.debug('Added page content to event stream as environment info');\n      }\n    } catch (error) {\n      // Log error but don't fail the main operation\n      this.logger.warn(\n        `Failed to capture page content: ${error instanceof Error ? error.message : String(error)}`,\n      );\n    }\n  }\n\n  /**\n   * Set the event stream instance\n   * @param eventStream - The event stream instance\n   */\n  public setEventStream(eventStream: EventStream): void {\n    this.eventStream = eventStream;\n  }\n\n  /**\n   * Get the tool definition for GUI Agent browser control\n   */\n  getToolDefinition(): ToolDefinition {\n    return this.guiAgentTool;\n  }\n\n  /**\n   * Hook for starting each agent loop\n   * - Takes a screenshot\n   * - Extracts image dimensions\n   * - Sends the screenshot to the event stream\n   */\n  async onEachAgentLoopStart(eventStream: EventStream, isReplaySnapshot = false): Promise<void> {\n    console.log('Agent Loop Start');\n\n    // Store the event stream for later use\n    this.eventStream = eventStream;\n\n    // Record screenshot start time\n    const startTime = performance.now();\n\n    // Handle replay state\n    if (isReplaySnapshot) {\n      // Send screenshot to event stream as environment input\n      const event = eventStream.createEvent(EventType.ENVIRONMENT_INPUT, {\n        content: [\n          {\n            type: 'image_url',\n            image_url: {\n              url: 'data:image/jpeg;base64,/9j/4AAQSk',\n            },\n          },\n        ],\n        description: 'Browser Screenshot',\n      });\n\n      return eventStream.sendEvent(event);\n    }\n\n    try {\n      const output = await this.browserOperator.screenshot();\n\n      // Calculate screenshot time\n      const endTime = performance.now();\n      const screenshotTime = (endTime - startTime).toFixed(2);\n\n      // Extract image dimensions from screenshot\n      this.extractImageDimensionsFromBase64(output.base64);\n\n      // Calculate image size\n      const base64Data = output.base64.replace(/^data:image\\/\\w+;base64,/, '');\n      const sizeInBytes = Math.ceil((base64Data.length * 3) / 4);\n      const sizeInKB = (sizeInBytes / 1024).toFixed(2);\n\n      // FIXME: using logger\n      console.log('Screenshot info:', {\n        width: this.screenWidth,\n        height: this.screenHeight,\n        size: `${sizeInKB} KB`,\n        time: `${screenshotTime} ms`,\n      });\n\n      // Send screenshot to event stream as environment input\n      const event = eventStream.createEvent(EventType.ENVIRONMENT_INPUT, {\n        content: [\n          {\n            type: 'image_url',\n            image_url: {\n              url: this.addBase64ImagePrefix(output.base64),\n            },\n          },\n        ],\n        description: 'Browser Screenshot',\n      });\n\n      eventStream.sendEvent(event);\n\n      // Also capture page content on loop start\n      // await this.capturePageContentAsEnvironmentInfo();\n    } catch (error) {\n      this.logger.error(`Failed to take screenshot: ${error}`);\n      throw error;\n    }\n  }\n\n  /**\n   * Add data URI prefix to base64 image if not present\n   */\n  private addBase64ImagePrefix(base64: string): string {\n    if (!base64) return '';\n    return base64.startsWith('data:') ? base64 : `data:image/jpeg;base64,${base64}`;\n  }\n\n  /**\n   * Parse operation string into a structured operation object\n   */\n  private parseAction(actionString: string): PredictionParsed {\n    // Extract operation type and parameter string\n    const actionTypeMatch = actionString.match(/^(\\w+)\\(/);\n    const action_type = actionTypeMatch ? actionTypeMatch[1] : '';\n\n    const action_inputs: ActionInputs = {};\n\n    // Handle coordinate points\n    const pointMatch = actionString.match(/point='<point>([\\d\\s]+)<\\/point>'/);\n    if (pointMatch) {\n      const [x, y] = pointMatch[1].split(' ').map(Number);\n      action_inputs.start_box = `[${x / this.factors[0]},${y / this.factors[1]}]`;\n    }\n\n    // Handle start and end coordinates (for drag operations)\n    const startPointMatch = actionString.match(/start_point='<point>([\\d\\s]+)<\\/point>'/);\n    if (startPointMatch) {\n      const [x, y] = startPointMatch[1].split(' ').map(Number);\n      action_inputs.start_box = `[${x / this.factors[0]},${y / this.factors[1]}]`;\n    }\n\n    const endPointMatch = actionString.match(/end_point='<point>([\\d\\s]+)<\\/point>'/);\n    if (endPointMatch) {\n      const [x, y] = endPointMatch[1].split(' ').map(Number);\n      action_inputs.end_box = `[${x / this.factors[0]},${y / this.factors[1]}]`;\n    }\n\n    // Handle content parameter (for type and finished operations)\n    const contentMatch = actionString.match(/content='([^']*(?:\\\\.[^']*)*)'/);\n    if (contentMatch) {\n      // Process escape characters\n      action_inputs.content = contentMatch[1]\n        .replace(/\\\\n/g, '\\n')\n        .replace(/\\\\'/g, \"'\")\n        .replace(/\\\\\"/g, '\"');\n    }\n\n    // Handle keys and hotkeys\n    const keyMatch = actionString.match(/key='([^']*)'/);\n    if (keyMatch) {\n      action_inputs.key = keyMatch[1];\n    }\n\n    // Handle scroll direction\n    const directionMatch = actionString.match(/direction='([^']*)'/);\n    if (directionMatch) {\n      action_inputs.direction = directionMatch[1];\n    }\n\n    return {\n      action_type,\n      action_inputs,\n    };\n  }\n\n  /**\n   * Extract width and height information from base64 encoded image\n   */\n  private extractImageDimensionsFromBase64(base64String: string): void {\n    // Remove base64 prefix (if any)\n    const base64Data = base64String.replace(/^data:image\\/\\w+;base64,/, '');\n\n    // Decode base64 to binary data\n    const buffer = Buffer.from(base64Data, 'base64');\n\n    // Check image type and extract dimensions\n    if (buffer[0] === 0x89 && buffer[1] === 0x50 && buffer[2] === 0x4e && buffer[3] === 0x47) {\n      // PNG format: width in bytes 16-19, height in bytes 20-23\n      this.screenWidth = buffer.readUInt32BE(16);\n      this.screenHeight = buffer.readUInt32BE(20);\n    } else if (buffer[0] === 0xff && buffer[1] === 0xd8) {\n      // JPEG format: need to parse SOF0 marker (0xFFC0)\n      let offset = 2;\n      while (offset < buffer.length) {\n        if (buffer[offset] !== 0xff) break;\n\n        const marker = buffer[offset + 1];\n        const segmentLength = buffer.readUInt16BE(offset + 2);\n\n        // SOF0, SOF2 markers contain dimension information\n        if ((marker >= 0xc0 && marker <= 0xc3) || (marker >= 0xc5 && marker <= 0xc7)) {\n          this.screenHeight = buffer.readUInt16BE(offset + 5);\n          this.screenWidth = buffer.readUInt16BE(offset + 7);\n          break;\n        }\n\n        offset += 2 + segmentLength;\n      }\n    }\n\n    // Ensure dimensions were extracted\n    if (!this.screenWidth || !this.screenHeight) {\n      this.logger.warn('Unable to extract dimension information from image data');\n    }\n  }\n\n  /**\n   * Get access to the underlying Puppeteer page\n   * This allows custom browser tools to be implemented\n   * without relying on the MCP Browser server\n   */\n  async getPage(): Promise<Page> {\n    if (!this.browser) {\n      throw new Error('Browser not initialized');\n    }\n\n    // Get active page or create a new one\n    try {\n      return await this.browser.getActivePage();\n    } catch (error) {\n      this.logger.warn('Failed to get active page, creating new page:', error);\n      return await this.browser.createPage();\n    }\n  }\n}\n"],"names":["sleep","time","Promise","resolve","setTimeout","GUIAgent","page","markdown","extractMarkdown","title","document","getVisibleText","node","Node","style","window","text","child","Array","mainContent","content","event","EventType","error","Error","String","eventStream","isReplaySnapshot","console","startTime","performance","output","endTime","screenshotTime","base64Data","sizeInBytes","Math","sizeInKB","base64","actionString","actionTypeMatch","action_type","action_inputs","pointMatch","x","y","Number","startPointMatch","endPointMatch","contentMatch","keyMatch","directionMatch","base64String","buffer","Buffer","offset","marker","segmentLength","options","BrowserOperator","Tool","z","thought","step","action","pageData","parsed","JSON","result"],"mappings":"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"}