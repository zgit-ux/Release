{"version":3,"file":"browser/content-extractor.js","sources":["webpack://@agent-tars/core/webpack/runtime/define_property_getters","webpack://@agent-tars/core/webpack/runtime/has_own_property","webpack://@agent-tars/core/webpack/runtime/make_namespace_object","webpack://@agent-tars/core/./src/browser/content-extractor.ts"],"sourcesContent":["__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n        if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n            Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n        }\n    }\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","/*\n * Copyright (c) 2025 Bytedance, Inc. and its affiliates.\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { READABILITY_SCRIPT, toMarkdown } from '@agent-infra/shared';\nimport { ConsoleLogger } from '@mcp-agent/core';\nimport { Page } from '@agent-infra/browser';\n\n/**\n * Content extraction result with pagination information\n */\nexport interface PaginatedContentResult {\n  /** The extracted content in markdown format */\n  content: string;\n  /** Total number of pages */\n  totalPages: number;\n  /** Current page number */\n  currentPage: number;\n  /** Whether there are more pages available */\n  hasMorePages: boolean;\n  /** Original page title */\n  title?: string;\n}\n\n/**\n * PaginatedContentExtractor - Memory-efficient content extraction with pagination support\n *\n * This class leverages the Mozilla Readability algorithm to extract the main content\n * from web pages while supporting pagination to prevent memory issues on large pages.\n *\n * Key features:\n * - Uses Readability to isolate valuable content from web pages\n * - Converts HTML to markdown for better token efficiency\n * - Implements pagination to limit memory usage\n * - Provides detailed pagination metadata\n */\nexport class PaginatedContentExtractor {\n  private readonly logger: ConsoleLogger;\n  private readonly pageSize: number;\n\n  /**\n   * Create a new paginated content extractor\n   *\n   * @param logger - Logger instance for debugging and error reporting\n   * @param pageSize - Maximum number of characters per page\n   */\n  constructor(logger: ConsoleLogger, pageSize = 100000) {\n    this.logger = logger;\n    this.pageSize = pageSize;\n  }\n\n  /**\n   * Extract content from a web page with pagination support\n   *\n   * @param page - Puppeteer page object\n   * @param pageNumber - Page number to extract (1-based index)\n   * @returns Promise with paginated content result\n   */\n  async extractContent(page: Page, pageNumber = 1): Promise<PaginatedContentResult> {\n    try {\n      this.logger.debug(`Extracting content page ${pageNumber} with max length ${this.pageSize}`);\n\n      // Extract content using Readability algorithm on a document clone to prevent DOM flickering\n      const extractionResult = await page.evaluate((readabilityScript) => {\n        // Initialize Readability from script\n        const Readability = new Function('module', `${readabilityScript}\\nreturn module.exports`)(\n          {},\n        );\n\n        // Create a deep clone of the document to avoid modifying the visible DOM\n        const documentClone = document.cloneNode(true) as Document;\n\n        // Clean up the cloned document\n        documentClone\n          .querySelectorAll('script,noscript,style,link,svg,img,video,iframe,canvas,.reflist')\n          .forEach((el) => el.remove());\n\n        // Parse content from the clone\n        const article = new Readability(documentClone).parse();\n        const content = article?.content || '';\n        const title = document.title;\n\n        return {\n          content,\n          title: article?.title || title,\n          fullContent: content,\n        };\n      }, READABILITY_SCRIPT);\n\n      // Convert HTML content to markdown for better token efficiency\n      const fullMarkdown = toMarkdown(extractionResult.fullContent || '');\n\n      // Calculate pagination information\n      const totalPages = Math.ceil(fullMarkdown.length / this.pageSize);\n      const validPageNumber = Math.min(Math.max(1, pageNumber), totalPages);\n      const startIndex = (validPageNumber - 1) * this.pageSize;\n      const endIndex = Math.min(startIndex + this.pageSize, fullMarkdown.length);\n\n      // Extract the requested page content\n      const pageContent = fullMarkdown.substring(startIndex, endIndex);\n\n      // Add pagination information if there are multiple pages\n      let contentWithPagination = pageContent;\n      if (totalPages > 1) {\n        const paginationInfo = `\\n\\n---\\n\\n*Page ${validPageNumber} of ${totalPages}. ${\n          validPageNumber < totalPages\n            ? `There are ${totalPages - validPageNumber} more pages with additional content.`\n            : 'This is the last page.'\n        }*\\n`;\n        contentWithPagination += paginationInfo;\n      }\n\n      // Add title to first page if available\n      if (validPageNumber === 1 && extractionResult.title) {\n        contentWithPagination = `# ${extractionResult.title}\\n\\n${contentWithPagination}`;\n      }\n\n      return {\n        content: contentWithPagination,\n        totalPages,\n        currentPage: validPageNumber,\n        hasMorePages: validPageNumber < totalPages,\n        title: extractionResult.title,\n      };\n    } catch (error) {\n      this.logger.error(`Error extracting paginated content: ${error}`);\n      throw new Error(\n        `Content extraction failed: ${error instanceof Error ? error.message : String(error)}`,\n      );\n    }\n  }\n}\n"],"names":["__webpack_require__","definition","key","Object","obj","prop","Symbol","PaginatedContentExtractor","page","pageNumber","extractionResult","readabilityScript","Readability","Function","documentClone","document","el","article","content","title","READABILITY_SCRIPT","fullMarkdown","toMarkdown","totalPages","Math","validPageNumber","startIndex","endIndex","pageContent","contentWithPagination","paginationInfo","error","Error","String","logger","pageSize"],"mappings":"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"}