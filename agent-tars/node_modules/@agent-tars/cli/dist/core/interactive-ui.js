/**
* Copyright (c) 2025 Bytedance, Inc. and its affiliates.
* SPDX-License-Identifier: Apache-2.0
*/
"use strict";
var __webpack_require__ = {};
(()=>{
    __webpack_require__.n = (module)=>{
        var getter = module && module.__esModule ? ()=>module['default'] : ()=>module;
        __webpack_require__.d(getter, {
            a: getter
        });
        return getter;
    };
})();
(()=>{
    __webpack_require__.d = (exports1, definition)=>{
        for(var key in definition)if (__webpack_require__.o(definition, key) && !__webpack_require__.o(exports1, key)) Object.defineProperty(exports1, key, {
            enumerable: true,
            get: definition[key]
        });
    };
})();
(()=>{
    __webpack_require__.o = (obj, prop)=>Object.prototype.hasOwnProperty.call(obj, prop);
})();
(()=>{
    __webpack_require__.r = (exports1)=>{
        if ('undefined' != typeof Symbol && Symbol.toStringTag) Object.defineProperty(exports1, Symbol.toStringTag, {
            value: 'Module'
        });
        Object.defineProperty(exports1, '__esModule', {
            value: true
        });
    };
})();
var __webpack_exports__ = {};
__webpack_require__.r(__webpack_exports__);
__webpack_require__.d(__webpack_exports__, {
    startInteractiveWebUI: ()=>startInteractiveWebUI
});
const external_path_namespaceObject = require("path");
var external_path_default = /*#__PURE__*/ __webpack_require__.n(external_path_namespaceObject);
const external_child_process_namespaceObject = require("child_process");
const external_fs_namespaceObject = require("fs");
var external_fs_default = /*#__PURE__*/ __webpack_require__.n(external_fs_namespaceObject);
const interface_namespaceObject = require("@agent-tars/interface");
const server_namespaceObject = require("@agent-tars/server");
const external_boxen_namespaceObject = require("boxen");
var external_boxen_default = /*#__PURE__*/ __webpack_require__.n(external_boxen_namespaceObject);
const external_chalk_namespaceObject = require("chalk");
var external_chalk_default = /*#__PURE__*/ __webpack_require__.n(external_chalk_namespaceObject);
const external_gradient_string_namespaceObject = require("gradient-string");
var external_gradient_string_default = /*#__PURE__*/ __webpack_require__.n(external_gradient_string_namespaceObject);
const index_js_namespaceObject = require("../utils/index.js");
const external_state_js_namespaceObject = require("./state.js");
async function startInteractiveWebUI(options) {
    const { appConfig, isDebug } = options;
    if (!appConfig.server) appConfig.server = {
        port: 8888
    };
    if (!appConfig.workspace) appConfig.workspace = {};
    if (void 0 === appConfig.workspace.isolateSessions) appConfig.workspace.isolateSessions = false;
    const staticPath = external_path_default().resolve(__dirname, '../../static');
    if (!external_fs_default().existsSync(staticPath)) throw new Error('Interactive UI not found. Make sure agent-tars-web-ui is built and static files are available.');
    if (!appConfig.ui) appConfig.ui = {};
    appConfig.ui.staticPath = staticPath;
    const tarsServer = new server_namespaceObject.AgentTARSServer(appConfig, {
        agioProvider: (0, external_state_js_namespaceObject.getBootstrapCliOptions)().agioProvider
    });
    const server = await tarsServer.start();
    const app = tarsServer.getApp();
    setupUI(app, appConfig.server.port, isDebug, staticPath);
    const port = appConfig.server.port;
    const serverUrl = `http://localhost:${port}`;
    if (appConfig.logLevel !== interface_namespaceObject.LogLevel.SILENT) {
        const brandColor1 = '#4d9de0';
        const brandColor2 = '#7289da';
        const brandGradient = external_gradient_string_default()(brandColor1, brandColor2);
        const boxContent = [
            brandGradient.multiline('Agent TARS Server is ready!', {
                interpolation: 'hsv'
            }),
            '',
            `\u{1F389} Agent TARS is available at: ${external_chalk_default().underline(brandGradient(serverUrl))}`
        ].join('\n');
        console.log(external_boxen_default()(boxContent, {
            padding: 1,
            margin: {
                top: 1,
                bottom: 1
            },
            borderColor: brandColor2,
            borderStyle: 'round',
            dimBorder: true
        }));
        if (options.open) {
            const url = `http://localhost:${port}`;
            const command = 'darwin' === process.platform ? 'open' : 'win32' === process.platform ? 'start' : 'xdg-open';
            (0, external_child_process_namespaceObject.exec)(`${command} ${url}`, (err)=>{
                if (err) console.error(`Failed to open browser: ${err.message}`);
            });
        }
    }
    return server;
}
function setupUI(app, port, isDebug = false, staticPath) {
    if (isDebug) index_js_namespaceObject.logger.debug(`Using static files from: ${staticPath}`);
    const injectBaseURL = (req, res, next)=>{
        if (!req.path.endsWith('.html') && '/' !== req.path && !req.path.match(/^\/[^.]*$/)) return next();
        const protocol = req.protocol;
        const host = req.get('host');
        const baseURL = `${protocol}://${host}`;
        const indexPath = external_path_default().join(staticPath, 'index.html');
        let htmlContent = external_fs_default().readFileSync(indexPath, 'utf8');
        const scriptTag = `<script>
      window.AGENT_TARS_BASE_URL = "${baseURL}";
      console.log("AGENT_TARS: Using API baseURL:", window.AGENT_TARS_BASE_URL);
    </script>`;
        htmlContent = htmlContent.replace('</head>', `${scriptTag}\n</head>`);
        res.send(htmlContent);
    };
    app.get('/', injectBaseURL);
    app.get(/^\/[^.]*$/, injectBaseURL);
    app.use(server_namespaceObject.express["static"](staticPath));
    app.use((req, res, next)=>{
        if ('GET' === req.method && !req.path.includes('.')) return injectBaseURL(req, res, next);
        next();
    });
}
exports.startInteractiveWebUI = __webpack_exports__.startInteractiveWebUI;
for(var __webpack_i__ in __webpack_exports__)if (-1 === [
    "startInteractiveWebUI"
].indexOf(__webpack_i__)) exports[__webpack_i__] = __webpack_exports__[__webpack_i__];
Object.defineProperty(exports, '__esModule', {
    value: true
});
